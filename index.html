<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI é ­éƒ¨å‹•ä½œæ„Ÿæ¸¬ (ç¨ç«‹ä¼´å¥é¢æ¿ç‰ˆ)</title>
    
    <!-- 
      [é›¢ç·šç‰ˆè£½ä½œèªªæ˜]
      é›¢ç·šä½¿ç”¨æ™‚ï¼Œè«‹ç¢ºä¿ JS æª”æ¡ˆåœ¨åŒä¸€ç›®éŒ„ï¼Œä¸¦ä¿®æ”¹ä¸‹æ–¹çš„ src å¼•ç”¨ã€‚
    -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- å¤–éƒ¨æ¨£å¼è¡¨ -->
    <link rel="stylesheet" href="css/style.css">

    <!-- æ ¸å¿ƒæ¨¡çµ„ -->
    <script src="js/config.js"></script>
    <script src="js/AudioEngine.js"></script>
    <script src="js/CalibrationSystem.js"></script>
    <script src="js/FaceTracker.js"></script>
    <script src="js/UIController.js"></script>
    <script src="js/AccompanimentSystem.js"></script>
</head>
<body>

    <!-- éš±è—çš„æª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡† -->
    <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="handleFileSelect(event)">

    <div id="start-screen" class="start-screen">
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white mb-2 font-chinese">AI é ­éƒ¨å‹•ä½œæ„Ÿæ¸¬</h1>
            <p class="text-gray-400">Head Motion Tracker</p>
        </div>
        <button id="start-btn" class="start-btn-large">â–¶ é»æ“Šé–‹å§‹ (å•Ÿå‹•éŸ³æ•ˆ)</button>
        <p class="mt-4 text-sm text-gray-500">é»æ“Šå¾ŒéŸ³æ•ˆå°‡è‡ªå‹•é–‹å•Ÿ</p>
    </div>

    <div class="camera-container">
        <div id="loader" class="loader">
            <div class="spinner"></div>
            <div>ç³»çµ±åˆå§‹åŒ–ä¸­...<br>
                <span style="font-size:0.8rem; color:#aaa;">
                    è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™<br>
                    (è‹¥ä¸€ç›´é¡¯ç¤ºæ­¤ç•«é¢ï¼Œä»£è¡¨ JS æª”æ¡ˆç¼ºå¤±)
                </span>
            </div>
        </div>

        <div class="canvas-wrapper">
            <video id="input_video" playsinline></video>
            <canvas id="output_canvas"></canvas>
            
            <!-- æ–°å¢ï¼šè‡‰éƒ¨å°å¼•æ¡† HTML -->
            <div id="face-guide" class="face-guide">
                <div class="face-guide-text">è«‹å°‡è‡‰éƒ¨å°æº–æ¡†ç·šä¸­å¤®<br><span style='font-size:0.7rem; color:#aaa'>(å¯æ»¾è¼ªèª¿æ•´å¤§å°)</span></div>
            </div>

            <!-- æ–°å¢ï¼šå’Œå¼¦é¡¯ç¤ºçœ‹æ¿ -->
            <div id="chord-display" class="chord-display"></div>

            <!-- å³ä¸Šè§’éŸ³é«˜æ•¸æ“šé¢æ¿ -->
            <div id="note-info" class="note-info-panel">
                <div class="text-[0.6rem] text-gray-400 uppercase tracking-wider mb-1">Current Pitch</div>
                <div id="current-note-name" class="note-main">--</div>
                <div id="current-solfege" class="note-sub">ç­‰å¾…æ¼”å¥...</div>
                <div id="current-freq" class="note-freq mt-1">0 Hz</div>
            </div>
            
            <div class="hud-overlay">
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>

                <div class="data-panel">
                    <div>YAW: <span id="val-yaw">0.00</span></div>
                    <div>PITCH: <span id="val-pitch">0.00</span></div>
                    <div style="margin-top:5px; font-size: 0.8rem; opacity: 0.7;">FPS: <span id="val-fps">0</span></div>
                    <div style="margin-top:5px; color: #fbbf24;" id="mode-indicator">æ¨¡å¼: å¯èª¿å¼åœ“åœˆè§¸ç™¼</div>
                    <div id="octave-indicator" class="octave-badge">ğŸ¹ éŸ³é«˜: æ¨™æº–</div>
                    <div style="margin-top:5px;">ç‹€æ…‹: <span id="trigger-state" class="text-green-400">å°±ç·’</span></div>
                </div>

                <div class="status-panel">
                    <div class="text-xs text-cyan-400 mb-1">DETECTED ACTION</div>
                    <div class="flex items-center justify-center">
                        <div id="status-text" class="status-text">WAITING...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¨ç«‹çš„ä¼´å¥æŒ‰éˆ• -->
        <button class="btn-base accomp-btn" onclick="toggleAccompPanel()">ğŸ¹ ä¼´å¥è¨­å®š</button>
        <button class="btn-base toggle-btn" onclick="toggleCalibration()">âš™ï¸ æ ¡æ­£èˆ‡è¨­å®š</button>
        
        <button id="sound-toggle" class="btn-base sound-btn" onclick="toggleSound()">
            <span>ğŸ”‡</span> é»æ“Šé–‹å•ŸéŸ³æ•ˆ (è«‹æª¢æŸ¥éœéŸ³éµ)
        </button>

        <div id="calib-panel" class="side-panel">
            <h3 class="text-lg font-bold mb-2 border-b border-gray-700 pb-2">æ ¡æ­£èˆ‡è¨­å®š</h3>
            
            <div class="mb-3 pb-2">
                <label class="text-xs text-blue-400 block mb-2 font-bold">ğŸ“ è¨­å®šæª” (Profile)</label>
                <div class="flex gap-2">
                    <button onclick="switchProfile(1)" id="profile-btn-1" class="profile-btn active">1</button>
                    <button onclick="switchProfile(2)" id="profile-btn-2" class="profile-btn">2</button>
                    <button onclick="switchProfile(3)" id="profile-btn-3" class="profile-btn">3</button>
                </div>
            </div>
            
            <div class="mode-switch">
                <button id="mode-rec-btn" onclick="setEditMode(false)" class="active-rec">ğŸ”´ éŒ„è£½ä½ç½®</button>
                <button id="mode-edit-btn" onclick="setEditMode(true)">ğŸ”µ ç·¨è¼¯åƒæ•¸</button>
            </div>

            <div id="rec-controls">
                <button onclick="setCenter()" class="mb-2 w-full bg-cyan-900/50 hover:bg-cyan-900 text-cyan-200 py-2 rounded text-xs border border-cyan-800 flex items-center justify-center gap-2">
                    <span>ğŸ¯</span> æ‰‹å‹•è¨­å®šç•¶å‰ç‚ºä¸­å¿ƒé»
                </button>

                <button id="range-btn" onclick="toggleRangeDetection()" class="mb-3 w-full bg-purple-900/50 hover:bg-purple-900 text-purple-200 py-2 rounded text-xs border border-purple-800 flex items-center justify-center gap-2">
                    <span>ğŸŒ€</span> é–‹å§‹åœ“å½¢ç¯„åœåµæ¸¬ (æ¨è–¦)
                </button>
                <p id="range-hint" class="text-[0.6rem] text-gray-400 mb-2 hidden">è«‹è¼•é¬†åœ°ç”¨é ­éƒ¨<b>è½‰å‹•ä¸€å€‹åœ“åœˆ</b>ï¼Œä¸ç”¨åˆ»æ„åˆ°æ¥µé™ã€‚</p>
            </div>

            <p id="grid-hint" class="text-xs text-gray-400">é»æ“Šä¸‹æ–¹æŒ‰éˆ•éŒ„è£½ä½ç½®ï¼š</p>
            <div class="grid-3x3">
                <button class="calib-btn" id="btn-1" onclick="handleGridClick(1, 'Do (1)')">1<small>Do</small></button>
                <button class="calib-btn" id="btn-2" onclick="handleGridClick(2, 'Re (2)')">2<small>Re</small></button>
                <button class="calib-btn" id="btn-3" onclick="handleGridClick(3, 'Mi (3)')">3<small>Mi</small></button>
                <button class="calib-btn" id="btn-4" onclick="handleGridClick(4, 'Fa (4)')">4<small>Fa</small></button>
                <button class="calib-btn" id="btn-5" onclick="handleGridClick(5, 'ç„¡ (5)')">5<small>ç„¡</small></button>
                <button class="calib-btn" id="btn-6" onclick="handleGridClick(6, 'So (6)')">6<small>So</small></button>
                <button class="calib-btn" id="btn-7" onclick="handleGridClick(7, 'La (7)')">7<small>La</small></button>
                <button class="calib-btn" id="btn-8" onclick="handleGridClick(8, 'Si (8)')">8<small>Si</small></button>
                <button class="calib-btn" id="btn-9" onclick="handleGridClick(9, 'High Do')">9<small>High Do</small></button>
            </div>

            <!-- å€‹åˆ¥è¨­å®šé¢æ¿ -->
            <div id="point-settings-panel" class="point-settings hidden">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-amber-400">è¨­å®š: <span id="selected-point-name">ç„¡</span></span>
                </div>
                
                <!-- æ–°å¢ï¼šåŸºéŸ³é¸æ“‡ -->
                <div class="mb-2">
                    <label class="text-[0.6rem] text-gray-400 block mb-1">ğŸµ è¨­å®šåŸºéŸ³ (Base Note)</label>
                    <select id="base-note-select" class="bg-gray-800 text-xs text-white p-1 rounded border border-gray-600 w-full">
                        <!-- Options generated by JS -->
                    </select>
                </div>
                
                <div class="mb-2">
                    <label class="text-[0.6rem] text-gray-400 block mb-1">å‡é™å¾®èª¿ (Semitone)</label>
                    <div class="flex gap-1">
                        <button onclick="setPointSemitone(-1)" id="semitone-flat-btn" class="semitone-btn">â™­</button>
                        <button onclick="setPointSemitone(0)" id="semitone-std-btn" class="semitone-btn active">â™®</button>
                        <button onclick="setPointSemitone(1)" id="semitone-sharp-btn" class="semitone-btn">â™¯</button>
                    </div>
                </div>

                <div>
                    <label class="text-[0.6rem] text-gray-400 block mb-1">å€‹åˆ¥åŠå¾‘: <span id="point-radius-val">40</span></label>
                    <input type="range" id="point-radius-slider" min="10" max="120" step="1" value="40" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            
            <!-- å…¨å±€åœ“åœˆå¤§å° (å·²éš±è—) -->
            <div class="mt-4 pt-2 border-t border-gray-700 hidden">
                <label class="text-xs text-green-400 block mb-2 font-bold">ğŸ¯ å…¨å±€åœ“åœˆå¤§å°</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="radius-slider" min="10" max="120" step="1" value="40" class="flex-grow">
                    <span id="radius-val" class="text-xs text-gray-300 w-6">40</span>
                </div>
            </div>

            <div class="mt-2">
                <label class="text-xs text-gray-400 block mb-2">åæ‡‰éˆæ•åº¦</label>
                <input type="range" id="speed-slider" min="0.02" max="0.5" step="0.01" value="0.15">
            </div>

            <!-- åº§æ¨™ç¸®æ”¾ç³»çµ± -->
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="section-title">ğŸ“ åº§æ¨™ç¸®æ”¾æ¨¡å¼</div>
                
                <div class="mb-3">
                    <div class="flex gap-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="scaling-mode" value="auto" onchange="setScalingMode('auto')" class="w-4 h-4 accent-purple-500">
                            <span class="text-xs text-gray-300">âœ¨ æ™ºèƒ½æ¨¡å¼ (è‡ªå‹•å„ªåŒ–)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="scaling-mode" value="manual" checked onchange="setScalingMode('manual')" class="w-4 h-4 accent-purple-500">
                            <span class="text-xs text-gray-300">ğŸ”§ æ‰‹å‹•æ¨¡å¼ (è‡ªè¨‚éˆæ•åº¦)</span>
                        </label>
                    </div>
                </div>

                <!-- æ‰‹å‹•æ¨¡å¼æ§åˆ¶ -->
                <div id="manual-scaling-controls" class="mb-2">
                    <div class="mb-2">
                        <div class="flex justify-between">
                            <label class="text-[0.6rem] text-gray-400">ğŸ”§ å·¦å³éˆæ•åº¦:</label>
                            <span id="yaw-scale-val" class="text-[0.6rem] text-gray-300">100%</span>
                        </div>
                        <input type="range" id="yaw-scale-slider" min="50" max="300" step="5" value="100" 
                               oninput="document.getElementById('yaw-scale-val').innerText = this.value + '%'; calibrationSystem.setYawScale(this.value);"
                               class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between">
                            <label class="text-[0.6rem] text-gray-400">ğŸ”§ ä¸Šä¸‹éˆæ•åº¦:</label>
                            <span id="pitch-scale-val" class="text-[0.6rem] text-gray-300">100%</span>
                        </div>
                        <input type="range" id="pitch-scale-slider" min="50" max="300" step="5" value="100"
                               oninput="document.getElementById('pitch-scale-val').innerText = this.value + '%'; calibrationSystem.setPitchScale(this.value);"
                               class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-green-500">
                    </div>
                </div>

                <!-- æ™ºèƒ½æ¨¡å¼è³‡è¨Š -->
                <div id="auto-scaling-info" class="hidden">
                    <div id="auto-scaling-info-text" class="p-2 bg-purple-900/30 rounded border border-purple-700">
                        <div class="text-xs text-gray-400 mb-1">âœ¨ è‡ªå‹•æ­¸ä¸€åŒ–ï¼šå·²å•Ÿç”¨</div>
                        <div class="text-xs text-gray-300">ä½¿ç”¨ã€Œåœ“å½¢ç¯„åœåµæ¸¬ã€è‡ªå‹•è¨ˆç®—æœ€ä½³ç¸®æ”¾</div>
                    </div>
                </div>
            </div>

            <!-- éŸ³æ•ˆè¨­å®šå€å¡Š -->
            <div class="section-title">ğŸµ éŸ³æ•ˆè¨­å®š</div>
            
            <div class="flex items-center justify-between mb-2 p-2 bg-gray-800 rounded border border-gray-600">
                <label class="text-xs text-gray-300 font-bold cursor-pointer" for="return-center-toggle">å›ä¸­é‡ç½® (å–®æ¬¡è§¸ç™¼)</label>
                <!-- ç§»é™¤ checked å±¬æ€§ï¼Œé è¨­ä¸é–‹å•Ÿ -->
                <input type="checkbox" id="return-center-toggle" class="w-4 h-4 accent-purple-500 cursor-pointer">
            </div>

            <div class="flex flex-col gap-2">
                <div class="flex flex-col gap-1">
                    <label class="text-xs text-gray-300">æ¨‚å™¨:</label>
                    <select id="instrument-select" class="bg-gray-800 text-xs text-white p-1 rounded border border-gray-600">
                        <option value="piano">ğŸ¹ æ¨¡æ“¬é‹¼ç´</option>
                        <option value="8bit">ğŸ‘¾ 8-Bit é›»å­éŸ³</option>
                        <option value="flute">ğŸŒ¬ï¸ é•·ç¬›</option>
                    </select>
                </div>
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between"><label class="text-[0.6rem] text-gray-400">éŸ³é‡:</label><span id="vol-val" class="text-[0.6rem] text-gray-300">50%</span></div>
                    <input type="range" id="vol-slider" min="0" max="100" step="1" value="50" class="accent-purple-500">
                </div>
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between"><label class="text-[0.6rem] text-gray-400">é•·åº¦:</label><span id="dur-val" class="text-[0.6rem] text-gray-300">1.5s</span></div>
                    <input type="range" id="dur-slider" min="0.1" max="3.0" step="0.1" value="1.5" class="accent-purple-500">
                </div>
            </div>

            <!-- æ–°å¢å˜´éƒ¨æ§åˆ¶å€å¡Š (å·²æ¢å¾©é¡¯ç¤º) -->
            <div>
                <div class="section-title">ğŸ‘„ å˜´éƒ¨æ§åˆ¶ (å…«åº¦åˆ‡æ›)</div>
                <div class="flex flex-col gap-2 mb-2">
                    <div class="flex items-center justify-between">
                        <label class="text-xs text-gray-300" for="mouth-enable-check">å•Ÿç”¨å˜´éƒ¨å…«åº¦æ§åˆ¶</label>
                        <input type="checkbox" id="mouth-enable-check" checked class="w-4 h-4 accent-pink-500">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-xs text-gray-400">è§¸ç™¼å‹•ä½œ:</label>
                        <select id="mouth-trigger-mode" class="bg-gray-800 text-xs text-white p-1 rounded border border-gray-600">
                            <option value="close" selected>ğŸ¤ é–‰å˜´ç¬é–“åˆ‡æ› (é è¨­)</option>
                            <option value="open">ğŸ˜® å¼µå˜´ç¬é–“åˆ‡æ›</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="debug-checkbox mt-4">
                <input type="checkbox" id="show-zones" checked onchange="toggleZones()">
                <label for="show-zones" class="text-yellow-200">é¡¯ç¤ºè§¸ç™¼åœˆ</label>
            </div>
            <!-- æ–°å¢ï¼šæ§åˆ¶å°å¼•æ¡†çš„é–‹é—œ -->
            <div class="debug-checkbox">
                <input type="checkbox" id="show-guide" checked onchange="toggleGuide()">
                <label for="show-guide" class="text-cyan-200">é¡¯ç¤ºé¢éƒ¨å°å¼•æ¡†</label>
            </div>
            <div class="debug-checkbox">
                <input type="checkbox" id="show-debug" checked onchange="toggleDebug()">
                <label for="show-debug">é¡¯ç¤ºè»Œè·¡ç´…é» & å˜´éƒ¨åµæ¸¬</label>
            </div>
            
            <div class="mt-4 border-t border-gray-700 pt-3 flex gap-2">
                <button onclick="saveConfig()" class="flex-1 bg-green-900/50 hover:bg-green-900 text-green-200 py-1 px-2 rounded text-xs border border-green-800">ğŸ’¾ å„²å­˜</button>
                <button onclick="loadConfig()" class="flex-1 bg-blue-900/50 hover:bg-blue-900 text-blue-200 py-1 px-2 rounded text-xs border border-blue-800">ğŸ“‚ è®€å–</button>
            </div>
            <div class="mt-2 flex gap-2">
                 <button onclick="exportCSV()" class="flex-1 bg-yellow-900/50 hover:bg-yellow-900 text-yellow-200 py-1 px-2 rounded text-xs border border-yellow-800">ğŸ“¤ åŒ¯å‡º CSV</button>
                 <button onclick="importCSV()" class="flex-1 bg-cyan-900/50 hover:bg-cyan-900 text-cyan-200 py-1 px-2 rounded text-xs border border-cyan-800">ğŸ“¥ åŒ¯å…¥ CSV</button>
            </div>
            <button onclick="resetCalibration()" class="mt-2 w-full bg-red-900/50 hover:bg-red-900 text-red-200 py-2 rounded text-xs border border-red-800">ğŸ—‘ï¸ é‡ç½®ç•¶å‰è¨­å®š</button>
        </div>

        <!-- ç¨ç«‹çš„ä¼´å¥é¢æ¿ -->
        <div id="accomp-panel" class="side-panel">
            <h3 class="text-lg font-bold mb-2 border-b border-gray-700 pb-2">ğŸ¹ ä¼´å¥è¨­å®š</h3>
            <!-- è‡ªå‹•å’Œå¼¦ä¼´å¥å€å¡Š (Auto Chords) -->
            <div class="section-title">è‡ªå‹•å’Œå¼¦ä¼´å¥ (Auto Chords)</div>
            <div class="flex flex-col gap-2 p-2 bg-gray-800 rounded border border-gray-600">
                <div class="flex flex-col gap-1">
                    <label class="text-xs text-gray-400">é¸æ“‡æ›²é¢¨/é€²è¡Œ:</label>
                    <select id="chord-prog-select" class="bg-gray-700 text-xs text-white p-1 rounded border border-gray-500">
                        <option value="none">-- é—œé–‰ --</option>
                        <option value="metronome_4" selected>â± ç´”ç¯€æ‹å™¨ (4/4æ‹)</option>
                        <option value="metronome_3">â± ç´”ç¯€æ‹å™¨ (3/4æ‹)</option>
                        <!-- æ›´æ–°é¸å–®åç¨±ç‚º F å¤§èª¿ -->
                        <option value="amazing_grace">ğŸ™ å¥‡ç•°æ©å…¸ (3/4æ‹, Få¤§èª¿)</option>
                        <option value="pop_c">ğŸ¸ æµè¡Œ C å¤§èª¿ (4/4æ‹, C-G-Am-F)</option>
                        <option value="canon">ğŸ» å¡è¾²é€²è¡Œ (4/4æ‹)</option>
                        <option value="basic_1451">ğŸ¼ åŸºç¤ I-IV-V-I (4/4æ‹)</option>
                    </select>
                </div>
                
                <!-- New Section Selector -->
                <div id="section-select-container" class="flex flex-col gap-1 mt-1 hidden">
                    <label class="text-[0.6rem] text-gray-400">ç·´ç¿’æ®µè½ (Practice Section):</label>
                    <select id="section-select" class="bg-gray-700 text-xs text-white p-1 rounded border border-gray-500">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div class="flex flex-col gap-1 mt-1">
                    <label class="text-[0.6rem] text-gray-400">ä¼´å¥éŸ³è‰²:</label>
                    <select id="chord-instrument-select" class="bg-gray-700 text-xs text-white p-1 rounded border border-gray-500">
                        <option value="soft_pad">â˜ï¸ æŸ”å’Œå¢ŠéŸ³ (Soft Pad)</option>
                        <option value="piano" selected>ğŸ¹ é›»é‹¼ç´ (E.Piano)</option> <!-- é è¨­æ”¹ç‚ºé›»é‹¼ç´ï¼Œæ•ˆæœè¼ƒæ˜é¡¯ -->
                        <option value="strings">ğŸ» åˆæˆå¼¦æ¨‚ (Synth Strings)</option>
                        <option value="pluck">ğŸ¸ æ’¥å¼¦ (Pluck)</option>
                    </select>
                </div>

                <!-- æ–°å¢ï¼šåˆ†è§£å’Œå¼¦é–‹é—œ -->
                <div class="flex items-center gap-2 mt-2 bg-gray-700/50 p-1 rounded">
                    <input type="checkbox" id="arpeggio-check" class="w-4 h-4 accent-pink-500 cursor-pointer">
                    <label for="arpeggio-check" class="text-xs text-gray-200 cursor-pointer font-bold">åˆ†è§£å’Œå¼¦ (Arpeggio)</label>
                </div>

                <!-- æ–°å¢ï¼šç¯€æ‹å™¨é–‹é—œ -->
                <div class="flex items-center gap-2 mt-1 bg-gray-700/50 p-1 rounded">
                    <input type="checkbox" id="metronome-check" class="w-4 h-4 accent-red-500 cursor-pointer">
                    <label for="metronome-check" class="text-xs text-gray-200 cursor-pointer font-bold flex-1">é–‹å•Ÿç¯€æ‹å™¨ (Click)</label>
                    <div id="metronome-light" class="metronome-light" title="ç¯€æ‹æŒ‡ç¤ºç‡ˆ"></div>
                </div>

                <!-- æ–°å¢ï¼šèªéŸ³å ±è®€é–‹é—œï¼ˆç„¡éšœç¤™è¼”åŠ©ï¼‰-->
                <div class="flex items-center gap-2 mt-1 bg-purple-700/50 p-1 rounded border border-purple-600">
                    <input type="checkbox" id="voice-check" class="w-4 h-4 accent-purple-500 cursor-pointer">
                    <label for="voice-check" class="text-xs text-gray-200 cursor-pointer font-bold flex-1">ğŸ”Š èªéŸ³å ±è®€æ—‹å¾‹ (ç„¡éšœç¤™)</label>
                </div>

                <!-- èªé€Ÿèª¿æ•´ï¼ˆèªéŸ³å ±è®€å•Ÿç”¨æ™‚é¡¯ç¤ºï¼‰-->
                <div id="voice-rate-controls" class="mt-1 hidden">
                    <div class="flex items-center justify-between">
                        <label class="text-[0.6rem] text-gray-400">èªéŸ³é€Ÿåº¦:</label>
                        <span id="voice-rate-val" class="text-[0.6rem] text-gray-300">æ­£å¸¸</span>
                    </div>
                    <input type="range" id="voice-rate-slider" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
                </div>
                
                <div class="flex gap-2 items-center mt-2">
                    <button onclick="toggleAutoChords()" id="chord-play-btn" class="flex-1 bg-green-800/60 hover:bg-green-700 text-white py-1 rounded text-xs border border-green-600">â–¶ é–‹å§‹ä¼´å¥</button>
                </div>

                <div class="flex items-center justify-between mt-1">
                    <label class="text-[0.6rem] text-gray-400">é€Ÿåº¦ (BPM): <span id="bpm-val" class="text-gray-300">100</span></label>
                </div>
                <input type="range" id="bpm-slider" min="40" max="180" step="1" value="100" class="accent-pink-500 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">

                <div class="flex items-center justify-between mt-1">
                    <label class="text-[0.6rem] text-gray-400">ä¼´å¥éŸ³é‡:</label>
                    <span id="chord-vol-val" class="text-[0.6rem] text-gray-300">30%</span>
                </div>
                <input type="range" id="chord-vol-slider" min="0" max="100" step="1" value="30" class="accent-cyan-500 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // Phase 2 Modular Integration Layer
        // ä½¿ç”¨æ¨¡çµ„åŒ–æ¶æ§‹ï¼šCalibrationSystem + FaceTracker + UIController
        // ============================================================

        // å…¨åŸŸç‹€æ…‹è®Šæ•¸
        let audioCtx = null;
        let isSoundEnabled = false;
        let isDebugVisible = true;
        let isZonesVisible = true;
        
        // æ¨¡çµ„å¯¦ä¾‹
        let calibrationSystem = null;
        let faceTracker = null;
        let uiController = null;
        let accompaniment = null;
        
        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const soundBtn = document.getElementById('sound-toggle');
        const showDebugCheck = document.getElementById('show-debug');
        const showZonesCheck = document.getElementById('show-zones');
        const showGuideCheck = document.getElementById('show-guide');
        const faceGuide = document.getElementById('face-guide');

        // ============================================================
        // åˆå§‹åŒ–ç³»çµ±
        // ============================================================
        
        // Start Screen Handler
        startBtn.addEventListener('click', async () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            isSoundEnabled = true;
            soundBtn.innerHTML = "<span>ğŸ”Š</span> éŸ³æ•ˆå·²é–‹å•Ÿ";
            soundBtn.classList.add('active');
            startScreen.style.opacity = '0';
            setTimeout(() => { startScreen.style.display = 'none'; }, 500);
            playNote(523.25, null, true);
            
            if (showGuideCheck.checked) {
                faceGuide.classList.add('active');
                setTimeout(() => {
                    if (faceGuide.classList.contains('active')) {
                        faceGuide.classList.remove('active');
                        showGuideCheck.checked = false;
                    }
                }, 15000);
            }
        });

        // Touch/Click for AudioContext resume
        document.body.addEventListener('touchstart', function() {
            if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); }
        }, { once: true, passive: true });
        
        document.body.addEventListener('click', function() {
            if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); }
        }, { once: true });

        // ============================================================
        // åˆå§‹åŒ–æ¨¡çµ„
        // ============================================================
        
        // Initialize CalibrationSystem
        calibrationSystem = new CalibrationSystem({
            showFeedback: (msg) => uiController.showFeedback(msg),
            updateModeDisplay: (count) => uiController.updateModeDisplay(count),
            normalizeYaw: (raw) => raw - calibrationSystem.getCenterOffset().yaw,
            normalizePitch: (raw) => raw - calibrationSystem.getCenterOffset().pitch,
            onZonesToggle: (visible) => { isZonesVisible = visible; },
            onInstrumentChange: (inst) => { playNote(523.25, null, true); },
            onVolumeChange: (vol) => { playNote(523.25, null, true); },
            onPreviewNote: (pointId) => { playNote(0, pointId, true); },
            getSelectedPointId: () => uiController ? uiController.getSelectedPointId() : null
        });
        
        // Initialize UIController
        uiController = new UIController({
            onSoundToggle: toggleSound,
            onDebugToggle: (visible) => { isDebugVisible = visible; },
            onZonesToggle: (visible) => { isZonesVisible = visible; },
            onEditModeChange: (enable) => { /* handled by UIController itself */ },
            onRecordPose: (id, name) => calibrationSystem.recordPose(id, name, faceTracker.getSmoothYaw(), faceTracker.getSmoothPitch()),
            onPointSelect: (id) => { /* handled by UIController */ },
            onSetPointSemitone: (pointId, val) => {
                if (pointId && calibrationSystem.calibrationData[pointId]) {
                    calibrationSystem.calibrationData[pointId].semitoneShift = val;
                    calibrationSystem.saveConfig();
                    playNote(0, pointId, true);
                }
            },
            onProfileSwitch: (index) => calibrationSystem.switchProfile(index),
            onDragPoint: (pointId, newYaw, newPitch) => {
                calibrationSystem.calibrationData[pointId].yaw = newYaw;
                calibrationSystem.calibrationData[pointId].pitch = newPitch;
            },
            onWheelResize: (pointId, delta) => {
                const pointRadiusSlider = document.getElementById('point-radius-slider');
                const pointRadiusVal = document.getElementById('point-radius-val');
                let newR = (calibrationSystem.calibrationData[pointId].radius || 40) + delta;
                newR = Math.max(10, Math.min(200, newR));
                calibrationSystem.calibrationData[pointId].radius = newR;
                if (uiController.getSelectedPointId() == pointId) {
                    pointRadiusSlider.value = newR;
                    pointRadiusVal.innerText = newR;
                }
            },
            onToggleOctave: () => { uiController.toggleOctave(); },
            getCalibrationData: () => calibrationSystem.getCalibrationData(),
            defaultTriggerRadius: 40,
            DEFAULT_BASE_MIDI: calibrationSystem.DEFAULT_BASE_MIDI,
            mapToCanvas: (val, isYaw, width, height) => {
                const scale = 1.0;
                return isYaw ? (val * scale + 0.5) * width : (val * scale + 0.5) * height;
            }
        });
        
        // Initialize FaceTracker
        faceTracker = new FaceTracker({
            getSmoothingFactor: () => calibrationSystem.getSmoothingFactor(),
            getMouthControlEnabled: () => calibrationSystem.getMouthControlEnabled(),
            getMouthTriggerMode: () => calibrationSystem.getMouthTriggerMode(),
            onToggleOctave: () => uiController.toggleOctave(),
            getIsDebugVisible: () => isDebugVisible,
            getIsRangeDetecting: () => calibrationSystem.getIsRangeDetecting(),
            onRangeUpdate: (dispYaw, dispPitch) => calibrationSystem.updateRange(dispYaw, dispPitch),
            getRangeTrace: () => calibrationSystem.getRangeTrace(),
            getRangeBounds: () => calibrationSystem.getRangeBounds(),
            getCalibrationData: () => calibrationSystem.getCalibrationData(),
            getIsZonesVisible: () => isZonesVisible,
            getSelectedPointId: () => uiController.getSelectedPointId(),
            getIsEditMode: () => uiController.getIsEditMode(),
            onPlayNote: (freq, pointId) => playNote(freq, pointId, false),
            getSoundSettings: () => calibrationSystem.getSoundSettings(),
            getCenterOffset: () => calibrationSystem.getCenterOffset(),
            getScalingFactors: () => calibrationSystem.getScalingFactors()
        });
        
        // Initialize Accompaniment System
        accompaniment = new AccompanimentSystem({
            bpm: 100,
            volume: 0.3,
            instrument: 'soft_pad',
            metronomeEnabled: false,
            isArpeggio: false,

            onBarChange: (data) => {
                const chordDisplay = document.getElementById('chord-display');
                let melodyHint = '';
                if (data.hint) {
                    melodyHint = `<div style="font-size: 1.8rem; color: #00ffcc; margin-top: 8px; text-shadow: 0 0 15px rgba(0, 255, 204, 0.8); font-family: 'Share Tech Mono', monospace;">${data.hint}</div>`;
                }
                const displayBarNum = data.measureNumber || data.barIndex + 1;
                chordDisplay.innerHTML = `
                    <div style="font-size: 1rem; color: #9ca3af; text-shadow: none; margin-bottom: -5px;">ç¬¬ ${displayBarNum} å°ç¯€</div>
                    <div style="line-height: 1;">${data.chord === 'NC' ? 'Metronome' : data.chord}</div>
                    ${melodyHint}
                `;
            },

            onMetronomeBeat: (data) => {
                flashMetronomeLight(data.isAccent);
            },

            onStateChange: (data) => {
                const chordPlayBtn = document.getElementById('chord-play-btn');
                const chordDisplay = document.getElementById('chord-display');
                if (data.state === 'playing') {
                    chordPlayBtn.innerText = "â¹ åœæ­¢ä¼´å¥";
                    chordPlayBtn.classList.replace("bg-green-800/60", "bg-red-800/60");
                    chordPlayBtn.classList.replace("border-green-600", "border-red-600");
                    chordDisplay.classList.add('active');
                } else {
                    chordPlayBtn.innerText = "â–¶ é–‹å§‹ä¼´å¥";
                    chordPlayBtn.classList.replace("bg-red-800/60", "bg-green-800/60");
                    chordPlayBtn.classList.replace("border-red-600", "border-green-600");
                    chordDisplay.classList.remove('active');
                    chordDisplay.innerText = "";
                }
            }
        });

        // Accompaniment UI Bindings
        const chordInstrumentSelect = document.getElementById('chord-instrument-select');
        chordInstrumentSelect.addEventListener('change', (e) => {
            accompaniment.setInstrument(e.target.value);
        });

        const chordProgSelect = document.getElementById('chord-prog-select');
        const sectionSelectContainer = document.getElementById('section-select-container');
        const sectionSelect = document.getElementById('section-select');
        
        chordProgSelect.addEventListener('change', (e) => {
            const key = e.target.value;
            const sections = accompaniment.selectProgression(key);

            if (sections) {
                sectionSelectContainer.classList.remove('hidden');
                sectionSelect.innerHTML = '';
                sections.forEach((sec, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.innerText = sec.name;
                    sectionSelect.appendChild(opt);
                });
            } else {
                sectionSelectContainer.classList.add('hidden');
            }
        });

        sectionSelect.addEventListener('change', (e) => {
            accompaniment.selectSection(parseInt(e.target.value) || 0);
        });

        const bpmSlider = document.getElementById('bpm-slider');
        const bpmVal = document.getElementById('bpm-val');
        bpmSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            bpmVal.innerText = value;
            accompaniment.setBpm(value);
        });

        const chordVolSlider = document.getElementById('chord-vol-slider');
        const chordVolVal = document.getElementById('chord-vol-val');
        chordVolSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value) / 100;
            chordVolVal.innerText = `${e.target.value}%`;
            accompaniment.setVolume(value);
        });

        const arpeggioCheck = document.getElementById('arpeggio-check');
        arpeggioCheck.addEventListener('change', (e) => {
            accompaniment.setArpeggio(e.target.checked);
        });

        const metronomeCheck = document.getElementById('metronome-check');
        metronomeCheck.addEventListener('change', (e) => {
            accompaniment.setMetronome(e.target.checked);
        });

        const voiceCheck = document.getElementById('voice-check');
        const voiceRateControls = document.getElementById('voice-rate-controls');
        const voiceRateSlider = document.getElementById('voice-rate-slider');
        const voiceRateVal = document.getElementById('voice-rate-val');

        voiceCheck.addEventListener('change', (e) => {
            accompaniment.setVoice(e.target.checked);
            // é¡¯ç¤º/éš±è—èªé€Ÿæ§åˆ¶
            if (e.target.checked) {
                voiceRateControls.classList.remove('hidden');
            } else {
                voiceRateControls.classList.add('hidden');
            }
        });

        voiceRateSlider.addEventListener('input', (e) => {
            const rate = parseFloat(e.target.value);
            accompaniment.setVoiceRate(rate);
            
            // æ›´æ–°é¡¯ç¤ºæ–‡å­—
            let rateText = 'æ­£å¸¸';
            if (rate < 0.8) rateText = 'å¾ˆæ…¢';
            else if (rate < 1.0) rateText = 'æ…¢';
            else if (rate > 1.5) rateText = 'å¾ˆå¿«';
            else if (rate > 1.2) rateText = 'å¿«';
            
            voiceRateVal.innerText = rateText;
        });

        function flashMetronomeLight(isAccent) {
            const metronomeLight = document.getElementById('metronome-light');
            metronomeLight.classList.add('active');
            if (isAccent) {
                metronomeLight.style.background = '#00ffcc';
                metronomeLight.style.boxShadow = '0 0 15px #00ffcc';
            } else {
                metronomeLight.style.background = '#ef4444';
                metronomeLight.style.boxShadow = '0 0 10px #ef4444';
            }
            setTimeout(() => {
                metronomeLight.classList.remove('active');
                metronomeLight.style.background = '#334155';
                metronomeLight.style.boxShadow = 'none';
            }, 100);
        }

        // ============================================================
        // éŸ³é »æ’­æ”¾é‚è¼¯
        // ============================================================
        
        function playNote(freq, pointId, forcePlay = false) {
            if (!isSoundEnabled || !audioCtx || !freq) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            let baseMidi = 0;
            let finalFreq = freq;

            if (pointId) {
                const calibData = calibrationSystem.getCalibrationData();
                const savedMidi = calibData[pointId]?.baseMidi;
                baseMidi = savedMidi !== undefined ? savedMidi : calibrationSystem.DEFAULT_BASE_MIDI[pointId];
                
                if (baseMidi !== null) {
                    let shifts = 0;
                    if (uiController.getIsHighOctave()) shifts += 12;
                    if (calibData[pointId]) {
                        shifts += (calibData[pointId].semitoneShift || 0);
                    }
                    const finalMidi = baseMidi + shifts;
                    finalFreq = 440 * Math.pow(2, (finalMidi - 69) / 12);
                    uiController.updateInfoPanel(finalMidi, pointId);
                } else if (!forcePlay) return;
            } else {
                uiController.updateInfoPanel(72, null);
            }
            
            if (finalFreq === 0) return;

            const now = audioCtx.currentTime;
            const soundSettings = calibrationSystem.getSoundSettings();
            const vol = soundSettings.volume;
            const dur = soundSettings.duration;
            const inst = soundSettings.instrument;

            const gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);

            let osc1, osc2;
            if (inst === 'piano') {
                osc1 = audioCtx.createOscillator();
                osc1.type = 'sine'; osc1.frequency.setValueAtTime(finalFreq, now);
                osc2 = audioCtx.createOscillator();
                osc2.type = 'triangle'; osc2.frequency.setValueAtTime(finalFreq, now);
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(vol, now + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + dur);
                osc1.connect(gainNode); osc2.connect(gainNode);
                osc1.start(now); osc1.stop(now + dur);
                osc2.start(now); osc2.stop(now + dur);
            } else if (inst === '8bit') {
                osc1 = audioCtx.createOscillator();
                osc1.type = 'square'; osc1.frequency.setValueAtTime(finalFreq, now);
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(vol * 0.3, now + 0.01);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                osc1.connect(gainNode);
                osc1.start(now); osc1.stop(now + 0.1);
            } else if (inst === 'flute') {
                osc1 = audioCtx.createOscillator();
                osc1.type = 'sine'; osc1.frequency.setValueAtTime(finalFreq, now);
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(vol * 0.8, now + 0.1);
                gainNode.gain.linearRampToValueAtTime(0.001, now + dur);
                osc1.connect(gainNode);
                osc1.start(now); osc1.stop(now + dur);
            }
        }

        // ============================================================
        // UI äº‹ä»¶è™•ç†å‡½æ•¸ï¼ˆå…¨åŸŸå‡½æ•¸ï¼Œä¾› onclick ä½¿ç”¨ï¼‰
        // ============================================================
        
        function toggleSound() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') { audioCtx.resume(); }
            isSoundEnabled = !isSoundEnabled;
            if (isSoundEnabled) {
                soundBtn.innerHTML = "<span>ğŸ”Š</span> éŸ³æ•ˆå·²é–‹å•Ÿ";
                soundBtn.classList.add('active');
                playNote(523.25, null, true);
            } else {
                soundBtn.innerHTML = "<span>ğŸ”‡</span> é»æ“Šé–‹å•ŸéŸ³æ•ˆ (è«‹æª¢æŸ¥éœéŸ³éµ)";
                soundBtn.classList.remove('active');
            }
        }

        function toggleCalibration() {
            uiController.toggleCalibration();
        }

        function toggleAccompPanel() {
            uiController.toggleAccompPanel();
        }

        function toggleDebug() {
            uiController.toggleDebug();
        }

        function toggleZones() {
            uiController.toggleZones();
        }

        function toggleGuide() {
            uiController.toggleGuide();
        }

        function setEditMode(enable) {
            uiController.setEditMode(enable);
        }

        function handleGridClick(id, name) {
            uiController.handleGridClick(id, name);
        }

        function setPointSemitone(val) {
            uiController.setPointSemitone(val);
        }

        function switchProfile(index) {
            uiController.switchProfile(index);
        }

        function setCenter() {
            calibrationSystem.setCenter(faceTracker.getRawYaw(), faceTracker.getRawPitch());
        }

        function toggleRangeDetection() {
            calibrationSystem.toggleRangeDetection(faceTracker.getSmoothYaw(), faceTracker.getSmoothPitch());
        }

        function resetCalibration() {
            calibrationSystem.resetCalibration();
        }

        function saveConfig() {
            calibrationSystem.saveConfig();
        }

        function loadConfig() {
            calibrationSystem.loadConfig();
        }

        function exportCSV() {
            calibrationSystem.exportCSV();
        }

        function importCSV() {
            calibrationSystem.importCSV();
        }

        function handleFileSelect(evt) {
            calibrationSystem.handleFileSelect(evt);
        }

        function setScalingMode(mode) {
            calibrationSystem.setScalingMode(mode);
        }

        function toggleAutoChords() {
            const key = chordProgSelect.value;
            if (key === 'none' && !accompaniment.isPlaying) {
                uiController.showFeedback("âš ï¸ è«‹å…ˆé¸æ“‡æ›²é¢¨");
                return;
            }

            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            accompaniment.setAudioContext(audioCtx);

            accompaniment.toggle(key);
        }

        // ============================================================
        // åˆå§‹åŒ– UI Controller & è¼‰å…¥è¨­å®š
        // ============================================================
        
        uiController.init();
        calibrationSystem.init();
        faceTracker.init();

        // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ JS åº«è¼‰å…¥
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Error:", message);
            if (message.includes("FaceMesh") || message.includes("Camera")) {
                const loader = document.getElementById('loader');
                if (loader) loader.innerHTML = `<div style="color:red; text-align:center;">ç¨‹å¼åº«è¼‰å…¥å¤±æ•—<br>è«‹ç¢ºèª JS æª”æ¡ˆæ˜¯å¦å­˜åœ¨</div>`;
            }
        };
    </script>
</body>
</html>
